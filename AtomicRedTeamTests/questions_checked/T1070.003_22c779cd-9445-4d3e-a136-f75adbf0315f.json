{
    "technique_id": "T1070.003",
    "question_id": "22c779cd-9445-4d3e-a136-f75adbf0315f",
    "context": "Attackers may use PowerShell to execute commands and then remove all traces by clearing the session history, hampering forensic investigations.",
    "objective": "Identify instances where the Clear-History cmdlet was invoked on a Windows host to erase PowerShell session logs.",
    "technical_details": {
        "command_analysis": "Examine recorded PowerShell command lines for the specific invocation that wipes history.",
        "detection_approach": "Search process creation events for powershell.exe with a command line containing the Clear-History cmdlet."
    },
    "thinking_how_to_phrase_question_and_answer": "Phrase the question to uncover the exact cmdlet used to clear the session history; the answer should be the command string itself.",
    "prompt": "On a Windows endpoint, review process execution logs to see if any PowerShell sessions were wiped clean. Which command was executed to clear the PowerShell history?",
    "answer": [
        "Clear-History"
    ],
    "difficulty": "medium",
    "KQL_query": "DeviceProcessEvents\n| where FileName in (\"powershell.exe\", \"pwsh.exe\")\n| where ProcessCommandLine has \"Clear-History\"\n| order by TimeGenerated desc",
    "KQL_validation_message": "KQL query validation successful: Within the provided query results, the field 'ProcessCommandLine' contains the string '\"powershell.exe\" & {Clear-History}', which matches the expected answer 'Clear-History'. This indicates that the activity involving 'Clear-History' is present and detectable in the data. The structure contains detailed process and command line telemetry, which is suitable for detecting such PowerShell command usage.",
    "KQL_query_results": [
        [
            "TenantId",
            "AccountDomain",
            "AccountName",
            "AccountObjectId",
            "AccountSid",
            "AccountUpn",
            "ActionType",
            "AdditionalFields",
            "AppGuardContainerId",
            "DeviceId",
            "DeviceName",
            "FileName",
            "FolderPath",
            "FileSize",
            "InitiatingProcessAccountDomain",
            "InitiatingProcessAccountName",
            "InitiatingProcessAccountObjectId",
            "InitiatingProcessAccountSid",
            "InitiatingProcessAccountUpn",
            "InitiatingProcessCommandLine",
            "InitiatingProcessFileName",
            "InitiatingProcessFolderPath",
            "InitiatingProcessId",
            "InitiatingProcessIntegrityLevel",
            "InitiatingProcessLogonId",
            "InitiatingProcessMD5",
            "InitiatingProcessParentFileName",
            "InitiatingProcessParentId",
            "InitiatingProcessSHA1",
            "InitiatingProcessSHA256",
            "InitiatingProcessTokenElevation",
            "InitiatingProcessFileSize",
            "InitiatingProcessVersionInfoCompanyName",
            "InitiatingProcessVersionInfoProductName",
            "InitiatingProcessVersionInfoProductVersion",
            "InitiatingProcessVersionInfoInternalFileName",
            "InitiatingProcessVersionInfoOriginalFileName",
            "InitiatingProcessVersionInfoFileDescription",
            "LogonId",
            "MD5",
            "MachineGroup",
            "ProcessCommandLine",
            "ProcessCreationTime",
            "ProcessId",
            "ProcessIntegrityLevel",
            "ProcessTokenElevation",
            "ProcessVersionInfoCompanyName",
            "ProcessVersionInfoProductName",
            "ProcessVersionInfoProductVersion",
            "ProcessVersionInfoInternalFileName",
            "ProcessVersionInfoOriginalFileName",
            "ProcessVersionInfoFileDescription",
            "InitiatingProcessSignerType",
            "InitiatingProcessSignatureStatus",
            "ReportId",
            "SHA1",
            "SHA256",
            "TimeGenerated",
            "Timestamp",
            "InitiatingProcessParentCreationTime",
            "InitiatingProcessCreationTime",
            "CreatedProcessSessionId",
            "IsProcessRemoteSession",
            "ProcessRemoteSessionDeviceName",
            "ProcessRemoteSessionIP",
            "InitiatingProcessSessionId",
            "IsInitiatingProcessRemoteSession",
            "InitiatingProcessRemoteSessionDeviceName",
            "InitiatingProcessRemoteSessionIP",
            "SourceSystem",
            "Type"
        ],
        [
            "54d61014-52aa-4bfc-9424-13aa153c5b27",
            "windows-vm",
            "wipro",
            "",
            "S-1-5-21-4034913605-1276698442-3985778739-500",
            "",
            "ProcessCreated",
            null,
            "",
            "51a5c6755c43d60b18a177bfa334701b37f9171e",
            "windows-vm",
            "powershell.exe",
            "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
            454656,
            "windows-vm",
            "wipro",
            "",
            "S-1-5-21-4034913605-1276698442-3985778739-500",
            "",
            "powershell  -Command \"Invoke-AtomicTest T1070.003 -TestGuids 22c779cd-9445-4d3e-a136-f75adbf0315f  -TimeoutSeconds 120 \"",
            "powershell.exe",
            "c:\\windows\\system32\\windowspowershell\\v1.0\\powershell.exe",
            2500,
            "High",
            2102526785,
            "909a2eec5534f01dff87b7d47e57bff7",
            "cmd.exe",
            9468,
            "bb26646b094923f080fc2f2ba363c4c28b33dc07",
            "d3b4b97c2bf97d70e5655ff4c4ca1d8cef9ded51685cfd764247cfda98ee68df",
            "TokenElevationTypeDefault",
            454656,
            "Microsoft Corporation",
            "Microsoft速 Windows速 Operating System",
            "10.0.26100.1",
            "POWERSHELL",
            "PowerShell.EXE",
            "Windows PowerShell",
            2102526785,
            "909a2eec5534f01dff87b7d47e57bff7",
            "",
            "\"powershell.exe\" & {Clear-History}",
            "2025-05-07 17:06:13.116662+00:00",
            6932,
            "High",
            "TokenElevationTypeDefault",
            "Microsoft Corporation",
            "Microsoft速 Windows速 Operating System",
            "10.0.26100.1",
            "POWERSHELL",
            "PowerShell.EXE",
            "Windows PowerShell",
            "OsVendor",
            "Valid",
            1001433,
            "bb26646b094923f080fc2f2ba363c4c28b33dc07",
            "d3b4b97c2bf97d70e5655ff4c4ca1d8cef9ded51685cfd764247cfda98ee68df",
            "2025-05-07 17:06:13.132043+00:00",
            "2025-05-07 17:06:13.132043+00:00",
            "2025-05-07 17:06:09.817212+00:00",
            "2025-05-07 17:06:09.902267+00:00",
            0,
            false,
            "",
            "",
            0,
            false,
            "",
            "",
            "",
            "DeviceProcessEvents"
        ]
    ]
}