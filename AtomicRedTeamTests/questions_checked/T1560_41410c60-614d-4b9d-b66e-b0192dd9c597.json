{
    "technique_id": "T1560",
    "question_id": "41410c60-614d-4b9d-b66e-b0192dd9c597",
    "context": "On a Windows endpoint, an attacker used PowerShell to recursively compress user profile data into a ZIP archive before exfiltration.",
    "objective": "Detect PowerShell’s Compress-Archive activity and pinpoint the name of the resulting archive file.",
    "technical_details": {
        "command_analysis": "Inspect DeviceProcessEvents for PowerShell invocations of Compress-Archive and DeviceFileEvents for newly created .zip files.",
        "detection_approach": "Correlate process command lines containing ‘Compress-Archive’ with file creation events that show a .zip output in the user profile directory."
    },
    "thinking_how_to_phrase_question_and_answer": "Frame the question so the analyst seeks out the ZIP filename generated by that Compress-Archive command.",
    "prompt": "Windows system logs show PowerShell zipping up the contents of a user’s profile folder. Investigate process and file events to determine the exact name of the ZIP archive created.",
    "answer": [
        "T1560-data-ps.zip"
    ],
    "difficulty": "medium",
    "KQL_query": "let psEvents =\n    DeviceProcessEvents\n    | where FileName in~ (\"powershell.exe\", \"pwsh.exe\")\n    | where ProcessCommandLine contains \"Compress-Archive\"\n    | project DeviceId, DeviceName, ProcessId, ProcessCommandLine;\n\nlet zipEvents =\n    DeviceFileEvents\n    | where ActionType == \"FileCreated\"\n    | where FileName endswith \".zip\"\n    | where FolderPath startswith \"C:\\\\Users\\\\\"\n    | project DeviceId, InitiatingProcessId, ZipFileName = FileName, ZipFolderPath = FolderPath, zipTime = TimeGenerated;\n\npsEvents\n| join kind=inner zipEvents on $left.DeviceId == $right.DeviceId and $left.ProcessId == $right.InitiatingProcessId\n| extend EventTime = zipTime, Technique = \"T1560-data-ps.zip\"\n| project EventTime, DeviceName, ProcessCommandLine, ZipFolderPath, ZipFileName, Technique",
    "KQL_validation_message": "KQL query validation successful: The expected answer 'T1560-data-ps.zip' appears in both the 'ZipFileName' and 'Technique' fields in the query results, directly matching the expected answer. Additionally, related contextual fields (e.g., 'ProcessCommandLine') reinforce that this result represents the file and action of interest. The structure and content of the results would provide sufficient evidence to answer the detection question.",
    "KQL_query_results": [
        [
            "EventTime",
            "DeviceName",
            "ProcessCommandLine",
            "ZipFolderPath",
            "ZipFileName",
            "Technique"
        ],
        [
            "2025-05-07 16:27:16.672542+00:00",
            "windows-vm",
            "\"powershell.exe\" & {dir $env:USERPROFILE -Recurse | Compress-Archive -DestinationPath $env:USERPROFILE\\T1560-data-ps.zip}",
            "C:\\Users\\wipro\\T1560-data-ps.zip",
            "T1560-data-ps.zip",
            "T1560-data-ps.zip"
        ]
    ]
}